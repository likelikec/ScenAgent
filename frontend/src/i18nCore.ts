import { createContext } from 'react'

export type UiLanguage = 'zh' | 'en'

export const STORAGE_KEY = 'mobile_v4_language'

export type I18nContextValue = {
  language: UiLanguage
  setLanguage: (lang: UiLanguage) => void
  t: (key: string, vars?: Record<string, string | number>) => string
}

export const I18nContext = createContext<I18nContextValue | null>(null)

export function normalizeLanguage(raw: unknown): UiLanguage {
  const v = String(raw || '').trim().toLowerCase()
  if (v === 'en' || v === 'english') return 'en'
  return 'zh'
}

export const dictZh: Record<string, string> = {
  'app.subtitle': 'API 驱动的任务展示台',
  'nav.run': '发起任务',
  'nav.settings': '设置',
  'nav.recent': '最近任务',
  'nav.recent.empty': '暂无记录（提交一次任务后会自动加入）',

  'run.title': '发起任务',
  'run.subtitle': '上传 Scenario → 选择模式 → 提交 → 任务执行 → 结束后查看任务详情',
  'run.step1': '上传 Scenario（JSON）',
  'run.upload.desc': '上传 Scenario 配置',
  'run.upload.button': '上传并获取文件id',
  'run.upload.done': '已上传',
  'run.upload.label': 'Scenario JSON',
  'run.upload.placeholder': '选择 scenario.json',
  'run.upload.token.empty': '尚未上传或未获取文件id',
  'run.upload.history': '历史 Scenario',
  'run.upload.history.placeholder': '选择之前上传过的 Scenario（可选）',
  'run.upload.history.empty': '暂无历史记录',
  'run.upload.history.clear': '清空历史',
  'run.upload.apk.label': '上传 APK',
  'run.upload.apk.placeholder': '选择 .apk 文件',
  'run.upload.apk.done': '已挂载 APK',
  'run.upload.apk.remove': '移除',
  'run.step2': '选择执行模式',
  'run.executionMode': '执行模式',
  'run.taskConfig.desc': '定义任务参数',
  'run.mode.single': '单场景单APP',
  'run.mode.range': '单APP多场景',
  'run.mode.batch': '多APP多场景',
  'run.batchInfo.title': '批量模式说明',
  'run.batchInfo.desc': '批量模式将使用 Scenario 文件中的 run_config（如存在），否则使用默认逻辑。',
  'run.appId': 'app_id',
  'run.scenarioId': 'scenario_id',
  'run.scenarioStartId': 'scenario_start_id',
  'run.scenarioEndId': 'scenario_end_id',
  'run.runConfig': 'run_config（JSON 数组）',
  'run.runConfig.desc': '示例：[{"app_id":"A1","scenario_id":"S1"}]',
  'run.language': '界面语言',
  'run.outputLanguage': '输出语言',
  'run.submit': '提交执行',
  'run.targetTask': '目标任务',
  'run.batchTag': '（批量）',
  'run.requestFailed': '请求失败',

  'job.title': '任务详情',
  'job.testRecord': '测试记录',
  'job.smartTimeline': '测试时间轴',
  'job.liveTerminal': '日志',
  'job.artifacts.taskResults': '执行结果',
  'job.artifacts.script': '执行脚本',
  'job.artifacts.zip': '全量归档',
  'job.artifacts.download': '下载文件',
  'job.artifacts.desc': '查看并下载任务产物',
  'job.jobId': 'job_id',
  'job.openArtifacts': '产物与回放',
  'job.refresh': '刷新',
  'job.downloadOrPreview': '下载/预览',
  'job.fetchFailed': '获取状态失败',
  'job.polling': '轮询中…',
  'job.createdAt': 'created_at',
  'job.startedAt': 'started_at',
  'job.finishedAt': 'finished_at',
  'job.runDir': 'run_dir',
  'job.execError': '执行错误',
  'job.rawJson': '原始状态 JSON',
  'job.error.title': '任务失败',
  'job.error.apiKeyHint': '提示：请前往设置页面配置 API 密钥和模型信息',

  'artifacts.title': '产物与回放',
  'artifacts.jobId': 'job_id: {id}',
  'artifacts.back': '返回任务详情',
  'artifacts.refresh': '刷新状态',
  'artifacts.fetchFailed': '获取状态失败',
  'artifacts.actionFailed': '操作失败',
  'artifacts.selectRunDir': '选择 run_dir',
  'artifacts.selectRunDir.desc': 'range/batch 模式下可以切换不同子任务目录',
  'artifacts.selectRunDir.placeholder': '尚未生成 run_dir',
  'artifacts.quick': '结果下载与预览',
  'artifacts.preview': '预览',
  'artifacts.download': '下载',
  'artifacts.stop': '停止任务',
  'artifacts.liveLog': '终端日志',
  'artifacts.downloadAfterFinish': '任务结束后可在下方下载结果',
  'artifacts.imagePreview': '图片预览（相对路径）',
  'artifacts.imagePreview.desc': '例如：images/screenshot_1.png',
  'artifacts.previewImage': '预览图片',
  'artifacts.textPreview': '文本预览',
  'artifacts.chatPreview': 'chat_log 预览',

  'chat.empty': '无可展示内容',

  'settings.title': '设置',
  'settings.subtitle': '前后端分离时，前端通过 API_BASE_URL 访问后端',
  'settings.saveFailed': '保存失败',
  'settings.done': '已完成',
  'settings.apiBaseUrl.title': 'API_BASE_URL',
  'settings.apiBaseUrl.saved': '已保存 API_BASE_URL（刷新页面后仍会生效）',
  'settings.apiBaseUrl.save': '保存',
  'settings.language.title': '界面语言',
  'settings.language.desc': '切换系统的界面显示语言',
  'settings.llm.title': '主 LLM',
  'settings.summaryLlm.title': 'Summary LLM（可选）',
  'settings.llm.apiKey': 'api_key',
  'settings.llm.baseUrl': 'base_url',
  'settings.llm.model': 'model',
  'settings.llm.summaryApiKey': 'summary_api_key',
  'settings.llm.summaryBaseUrl': 'summary_base_url',
  'settings.llm.summaryModel': 'summary_model',
  'settings.llm.save': '写入后端',
  'settings.llm.saved': '已写入后端 LLM 配置（本地单机场景）',
}

export const dictEn: Record<string, string> = {
  'app.subtitle': 'API-driven task dashboard',
  'nav.run': 'Run',
  'nav.settings': 'Settings',
  'nav.recent': 'Recent Jobs',
  'nav.recent.empty': 'No history yet (submit a job to see it here).',

  'run.title': 'Run a Job',
  'run.subtitle': 'Upload Scenario → Choose mode → Submit → Job Execution → View Details',
  'run.step1': 'Upload Scenario (JSON)',
  'run.upload.desc': 'Upload Scenario config',
  'run.upload.button': 'Upload and get file id',
  'run.upload.done': 'Uploaded',
  'run.upload.label': 'Scenario JSON',
  'run.upload.placeholder': 'Select scenario.json',
  'run.upload.token.empty': 'Not uploaded yet or file id not obtained', 
  'run.upload.history': 'Scenario History',
  'run.upload.history.placeholder': 'Pick a previously uploaded scenario (optional)',
  'run.upload.history.empty': 'No history',
  'run.upload.history.clear': 'Clear history',
  'run.upload.apk.label': 'Upload APK',
  'run.upload.apk.placeholder': 'Select .apk file',
  'run.upload.apk.done': 'APK Attached',
  'run.upload.apk.remove': 'Remove',
  'run.step2': 'Choose mode',
  'run.executionMode': 'Execution Mode',
  'run.taskConfig.desc': 'Define task parameters',
  'run.mode.single': 'Single app & scenario',
  'run.mode.range': 'Single app, multiple scenarios',
  'run.mode.batch': 'Multiple apps & scenarios',
  'run.batchInfo.title': 'Batch Mode Info',
  'run.batchInfo.desc': "Batch mode will use 'run_config' from your scenario file if provided; otherwise default logic.",
  'run.appId': 'app_id',
  'run.scenarioId': 'scenario_id',
  'run.scenarioStartId': 'scenario_start_id',
  'run.scenarioEndId': 'scenario_end_id',
  'run.runConfig': 'run_config (JSON array)',
  'run.runConfig.desc': 'Example: [{"app_id":"A1","scenario_id":"S1"}]',
  'run.language': 'UI Language',
  'run.outputLanguage': 'Output Language',
  'run.submit': 'Submit',
  'run.targetTask': 'Target Task',
  'run.batchTag': '(Batch)',
  'run.requestFailed': 'Request failed',

  'job.title': 'Job Details',
  'job.testRecord': 'Test Record',
  'job.smartTimeline': 'Test Timeline',
  'job.liveTerminal': 'Terminal Log',
  'job.artifacts.taskResults': 'Task Results',
  'job.artifacts.script': 'Script (Plan)',
  'job.artifacts.zip': 'Full Archive (Zip)',
  'job.artifacts.download': 'Download File',
  'job.artifacts.desc': 'View and download job artifacts',
  'job.jobId': 'job_id',
  'job.openArtifacts': 'Artifacts',
  'job.refresh': 'Refresh',
  'job.downloadOrPreview': 'Download/Preview',
  'job.fetchFailed': 'Failed to fetch status',
  'job.polling': 'Polling…',
  'job.createdAt': 'created_at',
  'job.startedAt': 'started_at',
  'job.finishedAt': 'finished_at',
  'job.runDir': 'run_dir',
  'job.execError': 'Execution error',
  'job.rawJson': 'Raw JSON',
  'job.error.title': 'Task Failed',
  'job.error.apiKeyHint': 'Hint: Please configure API key and model information in Settings page',

  'artifacts.title': 'Artifacts',
  'artifacts.jobId': 'job_id: {id}',
  'artifacts.back': 'Back',
  'artifacts.refresh': 'Refresh',
  'artifacts.fetchFailed': 'Failed to fetch status',
  'artifacts.actionFailed': 'Operation failed',
  'artifacts.selectRunDir': 'Select run_dir',
  'artifacts.selectRunDir.desc': 'Range/batch mode can switch between different run directories',
  'artifacts.selectRunDir.placeholder': 'run_dir not generated yet',
  'artifacts.quick': 'Results download and preview',
  'artifacts.preview': 'Preview',
  'artifacts.download': 'Download',
  'artifacts.stop': 'Stop job',
  'artifacts.liveLog': 'Terminal log',
  'artifacts.downloadAfterFinish': 'Downloads are available after job finishes',
  'artifacts.imagePreview': 'Image preview (relative path)',
  'artifacts.imagePreview.desc': 'Example: images/screenshot_1.png',
  'artifacts.previewImage': 'Preview image',
  'artifacts.textPreview': 'Text preview',
  'artifacts.chatPreview': 'chat_log preview',

  'chat.empty': 'Nothing to display',

  'settings.title': 'Settings',
  'settings.subtitle': 'Frontend calls backend via API_BASE_URL',
  'settings.saveFailed': 'Save failed',
  'settings.done': 'Done',
  'settings.apiBaseUrl.title': 'API_BASE_URL',
  'settings.apiBaseUrl.saved': 'Saved API_BASE_URL (persists after refresh)',
  'settings.apiBaseUrl.save': 'Save',
  'settings.language.title': 'UI Language',
  'settings.language.desc': 'Switch the display language of the interface',
  'settings.llm.title': 'Main LLM',
  'settings.summaryLlm.title': 'Summary LLM (optional)',
  'settings.llm.apiKey': 'api_key',
  'settings.llm.baseUrl': 'base_url',
  'settings.llm.model': 'model',
  'settings.llm.summaryApiKey': 'summary_api_key',
  'settings.llm.summaryBaseUrl': 'summary_base_url',
  'settings.llm.summaryModel': 'summary_model',
  'settings.llm.save': 'Write to backend',
  'settings.llm.saved': 'Saved backend LLM config (single-user local mode)',
}

export function format(template: string, vars?: Record<string, string | number>): string {
  if (!vars) return template
  return template.replace(/\{(\w+)\}/g, (_, k: string) => (vars[k] === undefined ? `{${k}}` : String(vars[k])))
}
